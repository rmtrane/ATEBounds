<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Utilize two-sample data two get potential one-sample bounds â€¢ Bounds in Two-Sample Mendelian Randomization With Summary Statistics</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Utilize two-sample data two get potential one-sample bounds">
<meta property="og:description" content="See how we can use two-sample data to get a sense of what the bounds obtained from one-sample data could look like.
">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Bounds in Two-Sample Mendelian Randomization With Summary Statistics</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ACEBounds.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Exploration of Bounds</li>
    <li>
      <a href="../articles/bounds_from_bivariate.html">Bounds using Two-Sample Data</a>
    </li>
    <li>
      <a href="../articles/bounds_from_trivariate.html">Utilize two-sample data two get potential one-sample bounds</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">"Power" analysis</li>
    <li>
      <a href="../articles/power_sims.html">Monte carlo integration</a>
    </li>
    <li>
      <a href="../articles/power_sims_figures.html">Coverage of Null Effect</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Two-Sample Bounds using Multiple Instruments</li>
    <li>
      <a href="../articles/multiple_IVs_sims.html">Two-Sample Bounds using Multiple IV: Monte carlo integration and data prep</a>
    </li>
    <li>
      <a href="../articles/multiple_IVs_figures.html">Two-Sample Bounds using Multiple IV: Figures</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">How-To's</li>
    <li>
      <a href="../articles/polymake_example.html">Polymake Example</a>
    </li>
    <li>
      <a href="../articles/get_bounds.html">How to use the `get_bounds` function</a>
    </li>
    <li>
      <a href="../articles/example_analysis.html">Example Analysis of Data from the IEU GWAS Database</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rmtrane/ACEBounds/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="bounds_from_trivariate_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Utilize two-sample data two get potential one-sample bounds</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rmtrane/ACEBounds/blob/master/vignettes/bounds_from_trivariate.Rmd"><code>vignettes/bounds_from_trivariate.Rmd</code></a></small>
      <div class="hidden name"><code>bounds_from_trivariate.Rmd</code></div>

    </div>

    
    
<p>Bounds constructed using two-sample data generally provides much less information than bounds constructed using one-sample data. We will here see how we can squeeze a bit more information out of two-sample data by considering the potential distributions of <span class="math inline">\((X,Y)|Z\)</span> that are in agreement with the observed <span class="math inline">\(X|Z\)</span> and <span class="math inline">\(Y|Z\)</span>, and the model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rmtrane/ACEBounds">ACEBounds</a></span><span class="op">)</span></pre></div>
<p>We will consider IVs that take three levels. To generate values of <span class="math inline">\(P(X = 1 | Z = z)\)</span> we simply choose three values from a uniform distribution. The matrices obtained from the polymake program give us some constraints on the values of <span class="math inline">\(P(Y = 1 | Z = z)\)</span>. These are included below.</p>
<table class="table">
<colgroup>
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="center">gamma01</th>
<th align="center">gamma02</th>
<th align="center">gamma03</th>
<th align="center">gamma11</th>
<th align="center">theta11</th>
<th align="center">theta12</th>
<th align="center">theta13</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">1</td>
<td align="center">0</td>
<td align="center">-1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">0</td>
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">3</td>
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">2</td>
<td align="center">-1</td>
<td align="center">-1</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">3</td>
<td align="center">0</td>
<td align="center">-1</td>
<td align="center">2</td>
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">-1</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">-1</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">-1</td>
</tr>
<tr class="odd">
<td align="center">2</td>
<td align="center">1</td>
<td align="center">-1</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">-1</td>
<td align="center">-1</td>
</tr>
<tr class="even">
<td align="center">2</td>
<td align="center">-1</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">0</td>
<td align="center">-1</td>
<td align="center">-1</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">2</td>
<td align="center">-1</td>
<td align="center">-1</td>
<td align="center">0</td>
</tr>
<tr class="even">
<td align="center">0</td>
<td align="center">1</td>
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr class="odd">
<td align="center">0</td>
<td align="center">-1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr class="even">
<td align="center">-1</td>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
<tr class="odd">
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">2</td>
<td align="center">-1</td>
<td align="center">0</td>
<td align="center">-1</td>
</tr>
</tbody>
</table>
<p>The function <code>simulate_gammas_from_thetas</code> takes a vector of length 3 of values of <span class="math inline">\(P(X = 1 | Z = z)\)</span>, and return a vector of length 3 of values of <span class="math inline">\(P(Y = 1 | Z = z)\)</span> such that no constraint is violated.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="va">simulate_gammas_from_thetas</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">thetas</span><span class="op">)</span><span class="op">{</span>

  <span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">thetas</span><span class="op">)</span><span class="op">)</span>


  <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>

  <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,
                     min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">0</span>,
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co"># row 3</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span>, <span class="co"># row 5</span>
                     max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">1</span>,
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span>, <span class="co"># row 11</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="co"># row 16</span>
                     <span class="op">)</span>

  <span class="va">gammas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,
                     min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">0</span>,
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="co"># row 4</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span>, <span class="co"># row 6</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="co"># row 12</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span>, <span class="co"># row 9</span>
                     max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">1</span>,
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span>, <span class="co"># row 10</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="co"># row 13</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span>, <span class="co"># row 17</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># row 15</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">gammas</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>For each set of values of <span class="math inline">\(P(X = 1 | Z = z)\)</span> and <span class="math inline">\(P(Y = 1 | Z = z)\)</span>, we first get the constraints on the values of <span class="math inline">\(\text{Cov}(X,Y | Z = z)\)</span> that must be satisfied for the resulting distribution of <span class="math inline">\((X,Y|Z)\)</span> to be valid. Note: the constraints used are based on the inequalities <span class="math inline">\(0 \le P(X = x, Y = y | Z = z) \le 1\)</span>, and the IV inequalities <span class="math inline">\(\max_x \sum_y \max_z P(X = x, Y = y | Z = z) \le 1\)</span>. These hold no matter the number of levels of <span class="math inline">\(Z\)</span>. However, when the number of levels of <span class="math inline">\(Z\)</span> is greater than <span class="math inline">\(2\)</span>, these are not sufficient, only necessary, for the joint condition <span class="math inline">\((X,Y|Z)\)</span> to be valid. Therefore, every time we sample a set of values of <span class="math inline">\(\text{Cov}(X,Y | Z = z)\)</span>, we check if the resulting joint conditional violates any of the constraints using the results from polymake. If they do violate, we reject the set of values, and sample a new set of values. We do this <span class="math inline">\(1000\)</span> times, which results in us getting <span class="math inline">\(1000\)</span> possible distributions of <span class="math inline">\((X,Y|Z)\)</span> for each set of <span class="math inline">\((X|Z)\)</span> and <span class="math inline">\((Y|Z)\)</span>. Since this takes a while to run, we save the results to a .rds file, so we can read it in for later use.</p>
<p>The result of this chunk is a <code>tibble</code> calles <code>many_sample_joints</code> with 5 columns:</p>
<ul>
<li>
<code>j</code> is simply for book keeping</li>
<li>
<code>thetas</code> are the values of <span class="math inline">\(P(X = 1 | Z = z)\)</span>
</li>
<li>
<code>gammas</code> are the values of <span class="math inline">\(P(Y = 1 | Z = z)\)</span>
</li>
<li>
<code>pot_covs</code> contain the constraints on <span class="math inline">\(\text{Cov}(X, Y | Z = z)\)</span>
</li>
<li>
<code>samp_joints</code> with the sampled joint distributions, <span class="math inline">\(1000\)</span> for each set of <span class="math inline">\(P(X = 1 | Z = z)\)</span> and <span class="math inline">\(P(Y = 1 | Z = z)\)</span>.</li>
</ul>
<p>The first six rows are shown below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"vignettes_data/many_sample_joints.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">many_sample_joints</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"vignettes_data/many_sample_joints.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span>
  
  <span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">n_cores</span><span class="op">)</span>
 
  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">7226637</span><span class="op">)</span>
  <span class="va">sim_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>j <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>thetas <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">j</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
           gammas <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">thetas</span>, <span class="va">simulate_gammas_from_thetas</span><span class="op">)</span>,
           pot_covs <span class="op">=</span> <span class="fu">map2</span><span class="op">(</span><span class="va">thetas</span>, <span class="va">gammas</span>, <span class="va">potential_covs</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">many_sample_joints</span> <span class="op">&lt;-</span> <span class="va">sim_probs</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      samp_joints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map2.html">future_map2</a></span><span class="op">(</span><span class="va">pot_covs</span>, <span class="va">j</span>,
                                <span class="op">~</span><span class="fu"><a href="../reference/sample_joint_probs.html">sample_joint_probs</a></span><span class="op">(</span><span class="va">.x</span>, return_bounds <span class="op">=</span> <span class="cn">TRUE</span>, n <span class="op">=</span> <span class="fl">1000</span>, max_rejections <span class="op">=</span> <span class="fl">500</span>, 
                                                    print_progress <span class="op">=</span> <span class="cn">TRUE</span>, print_as_progress <span class="op">=</span> <span class="va">.y</span><span class="op">)</span>,
                               .options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/furrr_options.html">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>
  
  <span class="fu">write_rds</span><span class="op">(</span><span class="va">many_sample_joints</span>,
            <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"vignettes_data/many_sample_joints.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">many_sample_joints</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 6 x 5
##       j thetas    gammas    pot_covs         samp_joints         
##   &lt;int&gt; &lt;list&gt;    &lt;list&gt;    &lt;list&gt;           &lt;list&gt;              
## 1     1 &lt;dbl [3]&gt; &lt;dbl [3]&gt; &lt;named list [4]&gt; &lt;tibble [1,000 Ã— 4]&gt;
## 2     2 &lt;dbl [3]&gt; &lt;dbl [3]&gt; &lt;named list [4]&gt; &lt;tibble [1,000 Ã— 4]&gt;
## 3     3 &lt;dbl [3]&gt; &lt;dbl [3]&gt; &lt;named list [4]&gt; &lt;tibble [1,000 Ã— 4]&gt;
## 4     4 &lt;dbl [3]&gt; &lt;dbl [3]&gt; &lt;named list [4]&gt; &lt;tibble [1,000 Ã— 4]&gt;
## 5     5 &lt;dbl [3]&gt; &lt;dbl [3]&gt; &lt;named list [4]&gt; &lt;tibble [1,000 Ã— 4]&gt;
## 6     6 &lt;dbl [3]&gt; &lt;dbl [3]&gt; &lt;named list [4]&gt; &lt;tibble [1,000 Ã— 4]&gt;</code></pre>
<p>Everything we need is included in this object. We simply need to unnest a few list columns to get the upper and lower bounds for the sampled joint distributions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">trivariate_bounds</span> <span class="op">&lt;-</span> <span class="va">many_sample_joints</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest</span><span class="op">(</span><span class="va">samp_joints</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest</span><span class="op">(</span><span class="va">joint</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">bounds</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">j</span>, <span class="va">joint</span>, trivariate_lower <span class="op">=</span> <span class="va">lower</span>, trivariate_upper <span class="op">=</span> <span class="va">upper</span>, <span class="va">n_rejected</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">trivariate_bounds</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 6 x 5
##       j joint                   trivariate_lower trivariate_upper n_rejected
##   &lt;int&gt; &lt;list&gt;                             &lt;dbl&gt;            &lt;dbl&gt;      &lt;dbl&gt;
## 1     1 &lt;dbl[,2,3] [2 Ã— 2 Ã— 3]&gt;           -0.333            0.317          0
## 2     1 &lt;dbl[,2,3] [2 Ã— 2 Ã— 3]&gt;           -0.372            0.259          0
## 3     1 &lt;dbl[,2,3] [2 Ã— 2 Ã— 3]&gt;           -0.336            0.306          0
## 4     1 &lt;dbl[,2,3] [2 Ã— 2 Ã— 3]&gt;           -0.329            0.280          0
## 5     1 &lt;dbl[,2,3] [2 Ã— 2 Ã— 3]&gt;           -0.334            0.259          0
## 6     1 &lt;dbl[,2,3] [2 Ã— 2 Ã— 3]&gt;           -0.336            0.282          0</code></pre>
<p>We then find the bounds we get if we only use the two-sample distributions.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">bivariate_bounds</span> <span class="op">&lt;-</span> <span class="va">many_sample_joints</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_bounds.html">get_bounds</a></span><span class="op">(</span>thetas <span class="op">=</span> <span class="va">thetas</span>, gammas <span class="op">=</span> <span class="va">gammas</span>, stop <span class="op">=</span> <span class="cn">FALSE</span>, warning <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,
         bivariate_constraints_violated <span class="op">=</span> <span class="va">bounds</span><span class="op">$</span><span class="va">constraints_violated</span>,
         interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">bounds</span><span class="op">$</span><span class="va">interval</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">interval</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bivariate_lower <span class="op">=</span> <span class="va">lower</span>,
         bivariate_upper <span class="op">=</span> <span class="va">upper</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">j</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"bivariate"</span><span class="op">)</span>, <span class="va">thetas</span>, <span class="va">gammas</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">bivariate_bounds</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 6 x 6
##       j bivariate_constraints_â€¦ bivariate_lower bivariate_upper thetas   gammas 
##   &lt;int&gt; &lt;lgl&gt;                             &lt;dbl&gt;           &lt;dbl&gt; &lt;list&gt;   &lt;list&gt; 
## 1     1 FALSE                            -0.374          0.335  &lt;dbl [3â€¦ &lt;dbl [â€¦
## 2     2 FALSE                            -0.319          0.192  &lt;dbl [3â€¦ &lt;dbl [â€¦
## 3     3 FALSE                            -0.169          0.321  &lt;dbl [3â€¦ &lt;dbl [â€¦
## 4     4 FALSE                            -0.722          0.162  &lt;dbl [3â€¦ &lt;dbl [â€¦
## 5     5 FALSE                            -0.478          0.0735 &lt;dbl [3â€¦ &lt;dbl [â€¦
## 6     6 FALSE                            -0.331          0.814  &lt;dbl [3â€¦ &lt;dbl [â€¦</code></pre>
<p>To plot it all, we combine the two sets of bounds. We order by lower limit of one-sample bounds, give <code>id</code> for plotting, and then create a variable <code>contains_zero</code> which simply tells us if the one-sample bounds contain zero (<code>TRUE</code>) or not (<code>FALSE</code>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">for_plot</span> <span class="op">&lt;-</span> <span class="va">trivariate_bounds</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">bivariate_bounds</span> <span class="op">%&gt;%</span> 
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>center <span class="op">=</span> <span class="op">(</span><span class="va">bivariate_upper</span> <span class="op">+</span> <span class="va">bivariate_lower</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">center</span><span class="op">)</span> <span class="op">%&gt;%</span> 
              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">j</span>, <span class="va">trivariate_lower</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>contains_zero <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">trivariate_lower</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">trivariate_upper</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"Overlaps Zero"</span>, <span class="st">"Does not Overlap Zero"</span><span class="op">)</span>,
         facet_row <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">k</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>, 
         facet_col <span class="op">=</span> <span class="va">k</span> <span class="op">-</span> <span class="op">(</span><span class="va">facet_row</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span></pre></div>
<pre><code>## Joining, by = "j"</code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">for_plot</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 6 x 16
##       j joint trivariate_lower trivariate_upper n_rejected bivariate_constâ€¦
##   &lt;int&gt; &lt;lis&gt;            &lt;dbl&gt;            &lt;dbl&gt;      &lt;dbl&gt; &lt;lgl&gt;           
## 1     1 &lt;dblâ€¦           -0.374            0.251          0 FALSE           
## 2     1 &lt;dblâ€¦           -0.374            0.252          0 FALSE           
## 3     1 &lt;dblâ€¦           -0.374            0.251          0 FALSE           
## 4     1 &lt;dblâ€¦           -0.373            0.255          0 FALSE           
## 5     1 &lt;dblâ€¦           -0.373            0.251          0 FALSE           
## 6     1 &lt;dblâ€¦           -0.373            0.258          0 FALSE           
## # â€¦ with 10 more variables: bivariate_lower &lt;dbl&gt;, bivariate_upper &lt;dbl&gt;,
## #   thetas &lt;list&gt;, gammas &lt;list&gt;, center &lt;dbl&gt;, k &lt;int&gt;, id &lt;int&gt;,
## #   contains_zero &lt;chr&gt;, facet_row &lt;dbl&gt;, facet_col &lt;dbl&gt;</code></pre>
<p>Finally, the plot.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="op">(</span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="va">for_plot</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">id</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">bivariate_lower</span>, color <span class="op">=</span> <span class="st">"Two-sample Bounds"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">bivariate_upper</span>, color <span class="op">=</span> <span class="st">"Two-sample Bounds"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">geom_errorbar</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">trivariate_lower</span>, 
                      xmax <span class="op">=</span> <span class="va">trivariate_upper</span>,
                      color <span class="op">=</span> <span class="va">contains_zero</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">geom_text</span><span class="op">(</span>data <span class="op">=</span> <span class="va">for_plot</span> <span class="op">%&gt;%</span> 
                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">j</span>, <span class="va">k</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"facet"</span><span class="op">)</span>, <span class="va">bivariate_upper</span><span class="op">)</span> <span class="op">%&gt;%</span> 
                <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="op">)</span>,
              <span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">j</span>, y <span class="op">=</span> <span class="fl">0.25</span>, x <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">bivariate_upper</span> <span class="op">&lt;</span> <span class="fl">0.6</span>,
                                                   <span class="fl">0.85</span>, <span class="op">-</span><span class="fl">0.85</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">facet_grid</span><span class="op">(</span><span class="va">facet_row</span> <span class="op">~</span> <span class="va">facet_col</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">coord_fixed</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red4"</span>, <span class="st">"grey50"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">""</span>, x <span class="op">=</span> <span class="st">"ATE"</span>,
         title <span class="op">=</span> <span class="st">"Bounds on ATE"</span>,
         color <span class="op">=</span> <span class="st">""</span>,
         linetype <span class="op">=</span> <span class="st">""</span>
    <span class="op">)</span> <span class="op">+</span> 
    <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>axis.ticks.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
          axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
          strip.background <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
          strip.text <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="bounds_from_trivariate_files/figure-html/plot-1.png" width="1500"></p>
<p>Save the plot to a file for later use.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu">ggsave</span><span class="op">(</span>
  <span class="va">plot</span>, 
  filename <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"figures/trivariate_bounds_plot.png"</span><span class="op">)</span>,
  width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">8</span>, dpi <span class="op">=</span> <span class="fl">300</span>
<span class="op">)</span></pre></div>
<p>Below are 9 of the 100 runs displayed. The figures are the same as in the plot below.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">chosen_ones</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">53</span>, <span class="fl">6</span>, <span class="fl">66</span>, 
                 <span class="fl">38</span>, <span class="fl">7</span>, <span class="fl">88</span>,
                 <span class="fl">73</span>, <span class="fl">44</span>, <span class="fl">60</span><span class="op">)</span>

<span class="va">for_subset_plot</span> <span class="op">&lt;-</span> <span class="va">for_plot</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">j</span> <span class="op">%in%</span> <span class="va">chosen_ones</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>J <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">j</span>, levels <span class="op">=</span> <span class="va">chosen_ones</span><span class="op">)</span><span class="op">)</span>,
         row_i <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">J</span> <span class="op">%in%</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span> <span class="op">~</span> <span class="st">"A"</span>,
                           <span class="va">J</span> <span class="op">%in%</span> <span class="fl">4</span><span class="op">:</span><span class="fl">6</span> <span class="op">~</span> <span class="st">"B"</span>,
                           <span class="va">J</span> <span class="op">%in%</span> <span class="fl">7</span><span class="op">:</span><span class="fl">9</span> <span class="op">~</span> <span class="st">"C"</span>,
                           <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NA_character_</span><span class="op">)</span>,
         col_j <span class="op">=</span> <span class="op">(</span><span class="va">J</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">%%</span> <span class="fl">3</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">subset_plot_summaries</span> <span class="op">&lt;-</span> <span class="va">for_subset_plot</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">row_i</span>, <span class="va">col_j</span>, <span class="va">thetas</span>, <span class="va">gammas</span>, <span class="va">J</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>bivariate_lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bivariate_lower</span><span class="op">)</span>,
            bivariate_upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">bivariate_upper</span><span class="op">)</span>,
            p_no_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">contains_zero</span> <span class="op">==</span> <span class="st">"Does not Overlap Zero"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>thetas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">thetas</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"P(X = 1 | Z = "</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
         gammas <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">gammas</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"P(Y = 1 | Z = "</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">2</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">thetas</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">gammas</span><span class="op">)</span></pre></div>
<pre><code>## `summarise()` regrouping output by 'row_i', 'col_j', 'thetas', 'gammas' (override with `.groups` argument)</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="va">subset_plot</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span><span class="va">for_subset_plot</span>,
                      <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">id</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_rect</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">3</span><span class="op">)</span>,
                              x_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">3</span><span class="op">)</span>,
                              y_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">3</span><span class="op">)</span>,
                              y_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">3</span><span class="op">)</span>,
                              contains_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Two-Sample Bounds"</span>, <span class="st">"Overlaps Zero"</span>, <span class="st">"Does not Overlap Zero"</span><span class="op">)</span><span class="op">)</span>,
            inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>,
            <span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">x_min</span>,
                xmax <span class="op">=</span> <span class="va">x_max</span>,
                ymin <span class="op">=</span> <span class="va">y_min</span>,
                ymax <span class="op">=</span> <span class="va">y_max</span>,
                fill <span class="op">=</span> <span class="va">contains_zero</span><span class="op">)</span>,
            alpha <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">bivariate_lower</span>, color <span class="op">=</span> <span class="st">"Two-Sample Bounds"</span><span class="op">)</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_vline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">bivariate_upper</span>, color <span class="op">=</span> <span class="st">"Two-Sample Bounds"</span><span class="op">)</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_errorbar</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">trivariate_lower</span>, 
                    xmax <span class="op">=</span> <span class="va">trivariate_upper</span>,
                    color <span class="op">=</span> <span class="va">contains_zero</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">facet_grid</span><span class="op">(</span><span class="va">row_i</span> <span class="op">~</span> <span class="va">col_j</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">coord_fixed</span><span class="op">(</span>ratio <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"grey50"</span>, <span class="st">"red"</span><span class="op">)</span>,
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Two-Sample Bounds"</span>, <span class="st">"Overlaps Zero"</span>, <span class="st">"Does not Overlap Zero"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"grey50"</span>, <span class="st">"red"</span><span class="op">)</span>,
                    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Two-Sample Bounds"</span>, <span class="st">"Overlaps Zero"</span>, <span class="st">"Does not Overlap Zero"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"ATE"</span>, 
       y <span class="op">=</span> <span class="st">""</span>,
       color <span class="op">=</span> <span class="st">""</span>,
       fill <span class="op">=</span> <span class="st">""</span>, 
       linetype <span class="op">=</span> <span class="st">""</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">guides</span><span class="op">(</span>
    color <span class="op">=</span> <span class="st">"none"</span>,
    fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>axis.ticks.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
        axis.text.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
        strip.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,
        legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,
        legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span>

<span class="va">subset_plot</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Bounds on ATE"</span><span class="op">)</span></pre></div>
<p><img src="bounds_from_trivariate_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>This is meant to illustrate the different scenarios we can end up in:</p>
<ul>
<li>The first row shows us three scenarios with relatively wide two-sample bounds, more or less centered around zero. Yet we would draw three different conclusions:
<ul>
<li>53: even with one-sample data, we would not be able to determine direction</li>
<li>6: with one-sample data, we would not be able to determine direction if the true ACE is negative. About % of the joint probabilities would result in the one-sample data giving us the direction, and in all of these cases the direction is positive.</li>
<li>66: with one-sample data, we would be able to determine direction with about % of the possible joint distributions, but the direction could go either way.</li>
</ul>
</li>
<li>The second row shows scenarios where the bounds are relatively wide and centered relatively far from zero (here, it is above, but you can similarly find cases where it would be below). Again, three difference conclusions:
<ul>
<li>38: even with one-sample data, would would not be able to determine direction</li>
<li>7: 0% of the drawn joint distributions let us determine direction, and in all cases the direction is positive.</li>
<li>88: % of the drawn joint distributions let us determine direction, and in all cases the direction is positive.</li>
<li>Notice the big difference in information in the two-sample data between 7 and 88 even though the two-sample bounds are relatively similar. One tells us that it is pretty likely that one-sample data would allow us to conclude the direction of the effect is positive, while the other one tells us it is rather unlikely we would be able to determine direction based on one-sample data.</li>
</ul>
</li>
<li>Finally, the third row shows us three scenarios where the two-sample bounds are relatively narrow and centered around zero. Once again, we would arrive at three different conclusions:
<ul>
<li>73: one-sample data would not help us determine direction</li>
<li>44: we would be able to determine direction from one-sample data in % of the drawn joints, but from the information in the two-sample data, we cannot rule out either direction. This seems rather surprising to me: even though the two-sample bounds are pretty tight around zero, bounds from one-sample data could still end up entirely on either side of zero!</li>
<li>60: in % of the drawn joints, we would be able to determine direction, and in all of these the direction is positive.</li>
</ul>
</li>
</ul>
<p>Save plot and a few summaries for later use.</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="fu">write_rds</span><span class="op">(</span>x <span class="op">=</span> <span class="va">subset_plot_summaries</span>,
          file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"vignettes_data"</span>, <span class="st">"subset_plot_summaries.Rds"</span><span class="op">)</span><span class="op">)</span>

<span class="fu">ggsave</span><span class="op">(</span>
  plot <span class="op">=</span> <span class="va">subset_plot</span>,
  filename <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"figures"</span>, <span class="st">"trivariate_bounds_subset_plot.png"</span><span class="op">)</span>,
  width <span class="op">=</span> <span class="fl">8</span>, dpi <span class="op">=</span> <span class="fl">300</span>, height <span class="op">=</span> <span class="fl">8</span>
<span class="op">)</span></pre></div>
<div id="monotonicity-of-px-1-z-z-u-" class="section level2">
<h2 class="hasAnchor">
<a href="#monotonicity-of-px-1-z-z-u-" class="anchor"></a>Monotonicity of <span class="math inline">\(P(X = 1 | Z = z, U)\)</span>.</h2>
<p>Below, we go through the exact same steps as above, except we now assume that <span class="math inline">\(P(X = 1 | Z = z, U)\)</span> is monotonically increasing.</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">simulate_gammas_from_thetas_mono</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">thetas</span><span class="op">)</span><span class="op">{</span>

  <span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">thetas</span><span class="op">)</span><span class="op">)</span>

  <span class="co">## constraints: </span>
  <span class="co"># matrices_from_polymake %&gt;%</span>
  <span class="co">#   filter(n_z_levels == 3, x_monotone, !y_monotone, data_format == "bivariate") %&gt;%</span>
  <span class="co">#   pull(matrix) %&gt;% .[[1]] %&gt;%</span>
  <span class="co">#   filter(alpha == 0) %&gt;%</span>
  <span class="co">#   select(where(~sum(abs(.x)) &gt; 0)) %&gt;%</span>
  <span class="co">#   filter(rowSums(abs(.)) &gt; 1)</span>
  
  <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>

  <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,
                     min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">0</span>,
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="co"># row 8</span>
                     max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">1</span>,
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># row 4</span>

  <span class="va">gammas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>,
                     min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">0</span>,
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="co"># row 5</span>
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, <span class="co"># row 3</span>
                     max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">1</span>,
                               <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span> <span class="op">-</span> <span class="va">thetas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="co"># row 2</span>
                               <span class="fl">1</span> <span class="op">+</span> <span class="va">gammas</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">gammas</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># row 7</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">gammas</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"vignettes_data/many_sample_joints_mono.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">many_sample_joints_mono</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"vignettes_data/many_sample_joints_mono.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span>

  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/interactive.html">interactive</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
    <span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="va">params</span><span class="op">$</span><span class="va">n_cores</span><span class="op">)</span>
 
  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2884193</span><span class="op">)</span>
  <span class="va">sim_probs_mono</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>j <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>thetas <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">j</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span>, min <span class="op">=</span> <span class="fl">0</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
           gammas <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">thetas</span>, <span class="va">simulate_gammas_from_thetas_mono</span><span class="op">)</span>,
           pot_covs <span class="op">=</span> <span class="fu">map2</span><span class="op">(</span><span class="va">thetas</span>, <span class="va">gammas</span>, <span class="va">potential_covs</span>, x_mono <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">many_sample_joints_mono</span> <span class="op">&lt;-</span> <span class="va">sim_probs_mono</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      samp_joints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map.html">future_map</a></span><span class="op">(</span><span class="va">pot_covs</span>, 
                               <span class="va">sample_joint_probs</span>, <span class="co">#x, </span>
                               return_bounds <span class="op">=</span> <span class="cn">TRUE</span>, n <span class="op">=</span> <span class="fl">1000</span>, max_rejections <span class="op">=</span> <span class="fl">100</span>,
                               x_mono <span class="op">=</span> <span class="cn">TRUE</span>,
                               .options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/furrr_options.html">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>
  
  <span class="fu">write_rds</span><span class="op">(</span><span class="va">many_sample_joints_mono</span>,
            <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"vignettes_data/many_sample_joints_mono.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">trivariate_bounds_mono</span> <span class="op">&lt;-</span> <span class="va">many_sample_joints_mono</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest</span><span class="op">(</span><span class="va">samp_joints</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest</span><span class="op">(</span><span class="va">joint</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">bounds</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">j</span>, <span class="va">joint</span>, trivariate_lower <span class="op">=</span> <span class="va">lower</span>, trivariate_upper <span class="op">=</span> <span class="va">upper</span>, <span class="va">n_rejected</span><span class="op">)</span>

<span class="va">bivariate_bounds_mono</span> <span class="op">&lt;-</span> <span class="va">many_sample_joints_mono</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_bounds.html">get_bounds</a></span><span class="op">(</span>thetas <span class="op">=</span> <span class="va">thetas</span>, gammas <span class="op">=</span> <span class="va">gammas</span>, x_mono <span class="op">=</span> <span class="cn">TRUE</span>, stop <span class="op">=</span> <span class="cn">FALSE</span>, warning <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,
         bivariate_constraints_violated <span class="op">=</span> <span class="va">bounds</span><span class="op">$</span><span class="va">constraints_violated</span>,
         interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">bounds</span><span class="op">$</span><span class="va">interval</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest_wider</span><span class="op">(</span><span class="va">interval</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>bivariate_lower <span class="op">=</span> <span class="va">lower</span>,
         bivariate_upper <span class="op">=</span> <span class="va">upper</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">j</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"bivariate"</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## # A tibble: 100 x 9
##        j thetas gammas pot_covs samp_joints bounds bivariate_constâ€¦
##    &lt;int&gt; &lt;list&gt; &lt;list&gt; &lt;list&gt;   &lt;list&gt;      &lt;list&gt; &lt;lgl&gt;           
##  1     1 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
##  2     2 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
##  3     3 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
##  4     4 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
##  5     5 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
##  6     6 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
##  7     7 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
##  8     8 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
##  9     9 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
## 10    10 &lt;dbl â€¦ &lt;dbl â€¦ &lt;named â€¦ &lt;tibble [1â€¦ &lt;nameâ€¦ FALSE           
## # â€¦ with 90 more rows, and 2 more variables: bivariate_lower &lt;dbl&gt;,
## #   bivariate_upper &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="va">for_plot_mono</span> <span class="op">&lt;-</span> <span class="va">trivariate_bounds_mono</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">bivariate_bounds_mono</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">j</span>, <span class="va">trivariate_lower</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>contains_zero <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">trivariate_lower</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">trivariate_upper</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="st">"Overlaps Zero"</span>, <span class="st">"Does not Overalp Zero"</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## Joining, by = "j"</code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="va">plot_mono</span> <span class="op">&lt;-</span> <span class="va">for_plot_mono</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>facet_row <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">j</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span>, 
         facet_col <span class="op">=</span> <span class="va">j</span> <span class="op">-</span> <span class="op">(</span><span class="va">facet_row</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">id</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">geom_hline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">bivariate_lower</span>, color <span class="op">=</span> <span class="st">"Two-Sample Bounds"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">geom_hline</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">bivariate_upper</span>, color <span class="op">=</span> <span class="st">"Two-Sample Bounds"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">geom_errorbar</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">trivariate_lower</span>, ymax <span class="op">=</span> <span class="va">trivariate_upper</span>,
                      color <span class="op">=</span> <span class="va">contains_zero</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.window.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">facet_grid</span><span class="op">(</span><span class="va">facet_row</span> <span class="op">~</span> <span class="va">facet_col</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">coord_fixed</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"grey50"</span>, <span class="st">"red4"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">""</span>, y <span class="op">=</span> <span class="st">"ACE"</span>,
         title <span class="op">=</span> <span class="st">"Bounds on ACE"</span>,
         caption <span class="op">=</span> <span class="st">"Assuming P(X = 1 | Z = z, U) is monotonically increasing."</span>,
         color <span class="op">=</span> <span class="st">""</span>,
         linetype <span class="op">=</span> <span class="st">""</span>
    <span class="op">)</span> <span class="op">+</span> 
    <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>axis.ticks.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,
          axis.text.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>

<span class="va">plot_mono</span></pre></div>
<p><img src="bounds_from_trivariate_files/figure-html/unnamed-chunk-7-1.png" width="3000"></p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="fu">ggsave</span><span class="op">(</span><span class="va">plot_mono</span>, filename <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"figures/trivariate_bounds_mono_plot.png"</span><span class="op">)</span>,
       width <span class="op">=</span> <span class="fl">10</span>, height <span class="op">=</span> <span class="fl">10</span>, dpi <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ralph MÃ¸ller Trane.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
