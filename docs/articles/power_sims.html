<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>"Power" Simulations • Bounds in Two-Sample Mendelian Randomization With Summary Statistics</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="" power simulations>
<meta property="og:description" content="">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Bounds in Two-Sample Mendelian Randomization With Summary Statistics</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ATEBounds.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="divider">
    <li class="dropdown-header">Exploration of Bounds</li>
    <li>
      <a href="../articles/bounds_from_bivariate.html">Bounds using Two-Sample Data</a>
    </li>
    <li>
      <a href="../articles/bounds_from_trivariate.html">Utilize two-sample data two get potential one-sample bounds</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">"Power" analysis</li>
    <li>
      <a href="../articles/power_sims.html">"Power" Simulations</a>
    </li>
    <li>
      <a href="../articles/power_sims_figures.html">"Power" Figures</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Two-Sample Bounds using Multiple Instruments</li>
    <li>
      <a href="../articles/multiple_IVs_sims.html">Multiple IVs: Simulations</a>
    </li>
    <li>
      <a href="../articles/multiple_IVs_figures.html">Multiple IVs: Figures</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Example Analysis using `TwoSampleMR`</li>
    <li>
      <a href="../articles/example_analysis.html">Example Analysis of Data from the IEU GWAS Database</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Other</li>
    <li>
      <a href="../articles/polymake_example.html">Polymake Example</a>
    </li>
    <li>
      <a href="../articles/get_bounds.html">How to use the `get_bounds` function</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rmtrane/ATEBounds/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="power_sims_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>“Power” Simulations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rmtrane/ATEBounds/blob/master/vignettes/power_sims.Rmd"><code>vignettes/power_sims.Rmd</code></a></small>
      <div class="hidden name"><code>power_sims.Rmd</code></div>

    </div>

    
    
<p>Here we briefly show how the monte carlo integration that provides the data used in <code><a href="../articles/power_sims_figures.html">vignette("power_sims_figures")</a></code> was performed. This happens in two steps: (1) create <span class="math inline">\(10,000,000\)</span> observations of <span class="math inline">\((X,Y,Z,U)\)</span>, and (2) summarize the simulated observations to get <span class="math inline">\(P(X|Z)\)</span> and <span class="math inline">\(P(Y|Z)\)</span>.</p>
<p>The first script showed below uses <code><a href="../reference/simulate_data.html">simulate_data()</a></code> to simulate <span class="math inline">\(10,000,000\)</span> observations for one of the combinations of <span class="math inline">\(\beta_X, \gamma_1, \gamma_U\)</span>. The other coefficients are set as <span class="math inline">\(\beta_0 = -\beta_X / 2, \beta_U = \gamma_U, \gamma_0 = -\gamma_1\)</span>. (See <code><a href="../reference/simulate_data.html">simulate_data()</a></code> for more details on the model.) The results are saved to a file. Note: these files are somewhat large, which is why this script is run for each combination of coefficients separately. This script was run for all 840 combinations. This is very time consuming, so rerun at own risk.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co">## Run for sim_n = 1,2,3,...,840.</span>
<span class="va">sim_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html">commandArgs</a></span><span class="op">(</span>trailingOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

<span class="co">## Only run if results don't already exist.</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"data/power_sims"</span>,
                           <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"power_sims_"</span>, <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="va">sim_n</span>, width <span class="op">=</span> <span class="fl">3</span>, side <span class="op">=</span> <span class="st">"left"</span>, pad <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="st">".rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>

  <span class="co">## Make sure V8 is available. If not, install in special folder.</span>
  <span class="co">## This is mainly a hack to make this work on our department's server, and can</span>
  <span class="co">## probably be removed.</span>
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jeroen/v8">V8</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>DOWNLOAD_STATIC_LIBV8 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"V8"</span>, repos <span class="op">=</span> <span class="st">"https://cloud.r-project.org"</span>, lib <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"V8"</span>, <span class="va">sim_n</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rmtrane/ACEBounds">ACEBounds</a></span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alexpghayes/distributions3">distributions3</a></span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">9866311</span><span class="op">)</span>

  <span class="co">## Create tibble with all combinations of coefficients, ids, and</span>
  <span class="co">## seed to use for each combination.</span>
  <span class="va">all_combos</span> <span class="op">&lt;-</span> <span class="fu">expand_grid</span><span class="op">(</span>indIVs_on_X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">6</span>, by <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>,
                            X_on_Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">1.5</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">6</span><span class="op">)</span>,
                            U_on_XY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span>,
           seed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">*</span><span class="fl">1e7</span>, digits <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>

  <span class="co">## Get the combination we are working on.</span>
  <span class="va">this_combo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">all_combos</span>, <span class="va">i</span> <span class="op">==</span> <span class="va">sim_n</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">this_combo</span><span class="op">$</span><span class="va">seed</span><span class="op">)</span>

  <span class="co">## Simulate data</span>
  <span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span>
    sample_size <span class="op">=</span> <span class="fl">1e7</span>,
    IVs_ps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span>,
    X_intercept <span class="op">=</span> <span class="op">-</span><span class="va">this_combo</span><span class="op">$</span><span class="va">indIVs_on_X</span>,
    Y_intercept <span class="op">=</span> <span class="op">-</span><span class="va">this_combo</span><span class="op">$</span><span class="va">X_on_Y</span><span class="op">/</span><span class="fl">2</span>,
    indIVs_on_X <span class="op">=</span> <span class="va">this_combo</span><span class="op">$</span><span class="va">indIVs_on_X</span>,
    indIVs_on_Y <span class="op">=</span> <span class="fl">0</span>,
    U <span class="op">=</span> <span class="fu">distributions3</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/distributions3/man/Normal.html">Normal</a></span><span class="op">(</span><span class="op">)</span>,
    U_on_X <span class="op">=</span> <span class="va">this_combo</span><span class="op">$</span><span class="va">U_on_XY</span>,
    U_on_Y <span class="op">=</span> <span class="va">this_combo</span><span class="op">$</span><span class="va">U_on_XY</span>,
    X_on_Y <span class="op">=</span> <span class="va">this_combo</span><span class="op">$</span><span class="va">X_on_Y</span>
  <span class="op">)</span>

  <span class="co">## Add simulated data to tibble and save to .Rds file.</span>
  <span class="fu">write_rds</span><span class="op">(</span><span class="va">this_combo</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sim_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">)</span><span class="op">)</span>,
            file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"data/power_sims"</span>,
                              <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"power_sims_"</span>, <span class="fu">str_pad</span><span class="op">(</span><span class="va">sim_n</span>, width <span class="op">=</span> <span class="fl">3</span>, side <span class="op">=</span> <span class="st">"left"</span>, pad <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, <span class="st">".rds"</span><span class="op">)</span><span class="op">)</span>,
            compress <span class="op">=</span> <span class="st">"gz"</span>,
            compression <span class="op">=</span> <span class="fl">9L</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>The script included below preps the results of the first script by finding the probabilities <span class="math inline">\(P(X|Z)\)</span> and <span class="math inline">\(P(Y|Z)\)</span>, and from there the two-sample bounds, and the ATE. Since we have observations on <span class="math inline">\((X,Y,Z,U)\)</span>, the ATE can be calculated. Once again, to limit the amount of memory required, we do this for 10 combinations at a time, and saving the results to files. The script displayed below does this. Again, beware that this is very time consuming.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co">## Specify number of cores for parallelization and run_n. Must be run for run_n = 1,2,3,...,84.</span>
<span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html">commandArgs</a></span><span class="op">(</span>trailingOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">run_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/commandArgs.html">commandArgs</a></span><span class="op">(</span>trailingOnly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>


<span class="co">## Make sure V8 is available. If not, install in special folder.</span>
<span class="co">## This is mainly a hack to make this work on our department's server, and can</span>
<span class="co">## probably be removed.</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jeroen/v8">V8</a></span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span>DOWNLOAD_STATIC_LIBV8 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"V8"</span>, repos <span class="op">=</span> <span class="st">"https://cloud.r-project.org"</span>, lib <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"V8"</span>, <span class="va">run_n</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rmtrane/ACEBounds">ACEBounds</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alexpghayes/distributions3">distributions3</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/progressr">progressr</a></span><span class="op">)</span>


<span class="co">## Helper function to find ATE from simulated data.</span>
<span class="va">ATE_from_simulated_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">from_simulate_data</span><span class="op">)</span><span class="op">{</span>
  <span class="va">intercept</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">from_simulate_data</span><span class="op">$</span><span class="va">coefficients</span>, <span class="va">effect</span> <span class="op">==</span> <span class="st">"Yintercept"</span><span class="op">)</span><span class="op">$</span><span class="va">coef</span>
  <span class="va">x_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">from_simulate_data</span><span class="op">$</span><span class="va">coefficients</span>, <span class="va">effect</span> <span class="op">==</span> <span class="st">"X_on_Y"</span><span class="op">)</span><span class="op">$</span><span class="va">coef</span>
  <span class="va">u_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">from_simulate_data</span><span class="op">$</span><span class="va">coefficients</span>, <span class="va">effect</span> <span class="op">==</span> <span class="st">"U_on_Y"</span><span class="op">)</span><span class="op">$</span><span class="va">coef</span>

  <span class="va">pY1X0</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">intercept</span> <span class="op">-</span> <span class="va">u_beta</span><span class="op">*</span><span class="va">from_simulate_data</span><span class="op">$</span><span class="va">simulated_data</span><span class="op">$</span><span class="va">U</span><span class="op">)</span><span class="op">)</span>
  <span class="va">pY1X1</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">intercept</span> <span class="op">-</span> <span class="va">x_beta</span> <span class="op">-</span> <span class="va">u_beta</span><span class="op">*</span><span class="va">from_simulate_data</span><span class="op">$</span><span class="va">simulated_data</span><span class="op">$</span><span class="va">U</span><span class="op">)</span><span class="op">)</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pY1X1</span> <span class="op">-</span> <span class="va">pY1X0</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">## Get files with results.</span>
<span class="va">all_power_sims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"data/power_sims"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu">plan</span><span class="op">(</span><span class="va">multisession</span>,
     workers <span class="op">=</span> <span class="va">n_cores</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>

<span class="co">## Which chunk of 10 are we working on?</span>
<span class="va">to_do</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>data_file <span class="op">=</span> <span class="va">all_power_sims</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>j <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">j</span> <span class="op">==</span> <span class="va">run_n</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/pkg/progressr/man/with_progress.html">with_progress</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/progressr/man/progressor.html">progressor</a></span><span class="op">(</span>steps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">to_do</span><span class="op">)</span><span class="op">)</span>

  <span class="co">## For each file...</span>
  <span class="va">bounds_and_ATE</span> <span class="op">&lt;-</span> <span class="va">to_do</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
      subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/furrr/man/future_map.html">future_map</a></span><span class="op">(</span>
        <span class="va">data_file</span>,
        <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
          <span class="co">## ... read in the file</span>
          <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

          <span class="co">## ... find summary statistics and ATE</span>
          <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">tmp</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
              sum_stats <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">sim_data</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">ACEBounds</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ACEBounds/man/probs_from_data.html">probs_from_data</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">simulated_data</span>, <span class="va">X</span>, <span class="va">Y</span>, <span class="va">Z1</span>, data_format <span class="op">=</span> <span class="st">"bivariate"</span><span class="op">)</span>,
                                           ATE <span class="op">=</span> <span class="fu">ATE_from_simulated_data</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
            <span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sim_data</span><span class="op">)</span> <span class="op">%&gt;%</span>
            <span class="co">## ... find bounds</span>
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>
              get_bounds_res <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">sum_stats</span>, <span class="op">~</span><span class="fu">ACEBounds</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ACEBounds/man/get_bounds.html">get_bounds</a></span><span class="op">(</span>gammas <span class="op">=</span> <span class="va">.x</span><span class="op">$</span><span class="va">gammas</span>, thetas <span class="op">=</span> <span class="va">.x</span><span class="op">$</span><span class="va">thetas</span>, stop <span class="op">=</span> <span class="cn">FALSE</span>, warning <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,
              bounds <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">get_bounds_res</span>, <span class="st">"interval"</span><span class="op">)</span>
            <span class="op">)</span>

          <span class="fu">p</span><span class="op">(</span><span class="op">)</span>

          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">)</span>
    <span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co">## Save to file</span>
<span class="fu">write_rds</span><span class="op">(</span><span class="va">bounds_and_ATE</span>, <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"data/power_results/power_bounds_and_ATE_"</span>, <span class="va">run_n</span>, <span class="st">".Rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Finally, we stitch together the 84 .Rds files with all the bounds from the 840 combinations of coefficients into one .Rds file.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="fu">map_dfr</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"data/power_results"</span><span class="op">)</span>,
                   pattern <span class="op">=</span> <span class="st">"power_bounds_and_ATE_[0-9]+.Rds"</span>,
                   full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
        <span class="va">read_rds</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">unnest</span><span class="op">(</span><span class="va">subset</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">write_rds</span><span class="op">(</span>file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span><span class="op">(</span><span class="st">"data/power_results/power_combined_results.Rds"</span><span class="op">)</span><span class="op">)</span></pre></div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ralph Møller Trane.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
